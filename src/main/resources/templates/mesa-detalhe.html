<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{base :: layout (~{::title}, ~{::section})}">
<head>
    <title>Mesa [[${mesa.id}]] - Detalhes</title>
</head>
<body>

<section class="section">
    <div class="container">
        <div style="margin-bottom: 20px;">
            <a href="/mesas" style="color: #a0a0a0; text-decoration: none;">
                <i class="fas fa-arrow-left"></i> Voltar para Mapa
            </a>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 class="section-title" style="margin-bottom: 0;">Mesa <span th:text="${mesa.id}">01</span></h2>

            <div>
                <span th:if="${mesa.estado == 0}" class="badge bg-success">LIVRE</span>
                <span th:if="${mesa.estado == 1}" class="badge bg-danger">OCUPADA</span>
                <span th:if="${mesa.estado == 2}" class="badge bg-warning text-dark">EM PAGAMENTO</span>
            </div>
        </div>

        <div class="comanda-container">

            <div class="comanda-box"
                 id="painel-consumo"
                 th:attr="hx-get=@{/mesas/{id}(id=${mesa.id})}"
                 hx-trigger="every 10s"
                 hx-select="#painel-consumo"
                 hx-swap="outerHTML">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: var(--accent); margin-bottom: 0;">Consumo</h3>
                    <span class="htmx-indicator" style="color: #666; font-size: 0.8rem;">
                        <i class="fas fa-sync fa-spin"></i> Atualizando...
                    </span>
                </div>

                <table class="table-items">
                    <thead>
                    <tr>
                        <th>Item</th>
                        <th>Qtd</th>
                        <th>Preço</th>
                        <th>Total</th>
                        <th sec:authorize="hasRole('GARCOM')"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="pedido : ${mesa.pedidos}">
                        <td>
                            <div th:text="${pedido.itemNome}">Nome do Item</div>
                            <small style="color: #888;" th:text="${pedido.itemTipoNome}">Tipo</small>
                        </td>
                        <td th:text="${pedido.quant}">1</td>
                        <td th:text="${'R$ ' + #numbers.formatDecimal(pedido.itemValor ?: 0, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</td>
                        <td th:text="${'R$ ' + #numbers.formatDecimal((pedido.itemValor ?: 0) * pedido.quant, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</td>

                        <td class="actions" sec:authorize="hasRole('GARCOM')">
                            <button class="btn btn-sm btn-outline-danger"
                                    style="border: none;"
                                    onclick="abrirModalCancelamento(this)"
                                    th:data-id="${pedido.id}"
                                    title="Cancelar Item">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(mesa.pedidos)}">
                        <td colspan="5" style="text-align: center; color: #666; font-style: italic; padding: 20px;">
                            Nenhum pedido realizado.
                        </td>
                    </tr>
                    </tbody>
                </table>

                <div class="financial-summary">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span th:text="${'R$ ' + #numbers.formatDecimal(mesa.subtotal ?: 0, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</span>
                    </div>

                    <div class="summary-row">
                        <span>Serviço (Gorjeta)</span>
                        <span th:text="${'R$ ' + #numbers.formatDecimal(mesa.gorjeta ?: 0, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</span>
                    </div>

                    <div class="summary-row">
                        <span>Entrada
                            <small style="color: #888;">(<span th:text="${mesa.nPessoas ?: 0}">1</span> pessoas)</small>
                            <small th:if="${mesa.pagaEntrada == null or !mesa.pagaEntrada}" style="color: #e74c3c;">(Isento)</small>
                        </span>
                        <span th:text="${'R$ ' + #numbers.formatDecimal(mesa.entrada ?: 0, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</span>
                    </div>

                    <div class="summary-row" th:if="${mesa.totalPago != null and mesa.totalPago > 0}">
                        <span style="color: #27ae60;">Já Pago</span>
                        <span style="color: #27ae60;" th:text="${'- R$ ' + #numbers.formatDecimal(mesa.totalPago ?: 0, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</span>
                    </div>

                    <div class="summary-row total" style="border-top: 1px solid #444; margin-top: 10px; padding-top: 10px; font-size: 1.2rem; color: var(--accent);">
                        <span>TOTAL A PAGAR</span>
                        <span th:text="${'R$ ' + #numbers.formatDecimal((mesa.total ?: 0) - (mesa.totalPago ?: 0), 1, 'POINT', 2, 'COMMA')}">R$ 0,00</span>
                    </div>
                </div>
            </div>

            <div class="actions-panel" sec:authorize="hasAnyRole('GARCOM', 'ADMIN')">
                <div class="comanda-box">
                    <h3>Operações</h3>

                    <div class="action-btn-group">

                        <form th:action="@{/mesas/{id}/pessoas(id=${mesa.id})}" method="post" style="margin-bottom: 15px;">
                            <label style="font-size: 0.8rem; color: #aaa; display: block; margin-bottom: 5px;">Pessoas na Mesa:</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="number" name="nPessoas" th:value="${mesa.nPessoas ?: 1}" min="1"
                                       class="form-control form-control-sm" style="background: #222; border: 1px solid #444; color: white;">
                                <button type="submit" class="btn btn-sm btn-outline-light">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </form>

                        <hr style="border-color: #333; margin: 15px 0;">

                        <div th:if="${mesa.estado == 1}">
                            <a th:href="@{/mesas/{id}/adicionar(id=${mesa.id})}" class="btn btn-primary w-100 mb-2">
                                <i class="fas fa-plus"></i> Adicionar Item
                            </a>
                        </div>

                        <div th:if="${mesa.estado == 0}">
                            <form th:action="@{/mesas/{id}/abrir(id=${mesa.id})}" method="post">
                                <button type="submit" class="btn btn-success w-100 mb-2">
                                    <i class="fas fa-door-open"></i> Abrir Mesa
                                </button>
                            </form>
                        </div>

                        <form th:action="@{/mesas/{id}/toggle-entrada(id=${mesa.id})}" method="post" style="margin-bottom: 10px;">
                            <button type="submit" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-ticket-alt"></i>
                                <span th:text="${mesa.pagaEntrada != null and mesa.pagaEntrada ? 'Isentar Entrada' : 'Cobrar Entrada'}">Entrada</span>
                            </button>
                        </form>

                        <hr style="border-color: #333; margin: 15px 0;">

                        <a th:if="${mesa.estado == 1 or mesa.estado == 2}"
                           th:href="@{/mesas/{id}/pagamento(id=${mesa.id})}"
                           class="btn btn-success w-100 mb-2" style="background-color: #27ae60; border: none;">
                            <i class="fas fa-dollar-sign"></i> Registrar Pagamento
                        </a>

                        <form th:if="${mesa.estado == 1}"
                              th:action="@{/mesas/{id}/fechar(id=${mesa.id})}"
                              method="post"
                              onsubmit="return confirm('Fechar a conta? Isso bloqueará novos pedidos.');">
                            <button type="submit" class="btn btn-warning w-100" style="color: #000; font-weight: bold;">
                                <i class="fas fa-file-invoice-dollar"></i> Fechar Conta
                            </button>
                        </form>

                        <form th:if="${mesa.estado == 2}"
                              th:action="@{/mesas/{id}/liberar(id=${mesa.id})}"
                              method="post"
                              onsubmit="return confirm('Tem certeza? A mesa ficará LIVRE para novos clientes.');">
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="fas fa-check-double"></i> Liberar Mesa
                            </button>
                        </form>

                    </div>
                </div>
            </div>

        </div>

        <script>
            function abrirModalCancelamento(btn) {
                const idItem = btn.getAttribute('data-id');
                const motivo = prompt("Motivo do cancelamento (Obrigatório):");
                if (motivo) {
                    window.location.href = `/pedidos/${idItem}/cancelar?motivo=${encodeURIComponent(motivo)}`;
                }
            }
        </script>
    </div>
</section>

</body>
</html>