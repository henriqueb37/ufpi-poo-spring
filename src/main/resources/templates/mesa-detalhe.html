<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{base :: layout (~{::title}, ~{::section})}">
<head>
    <title>Mesa [[${mesa.id}]] - Detalhes</title>
</head>
<body>

<section class="section">
    <div class="container">
        <!-- Botão de Voltar (Já que removemos a Navbar específica) -->
        <div style="margin-bottom: 20px;">
            <a href="/mesas" style="color: #a0a0a0; text-decoration: none; font-size: 0.9rem;">
                <i class="fas fa-arrow-left"></i> Voltar para Mapa
            </a>
        </div>

        <!-- Usando ID do DTO -->
        <h2 class="section-title">Mesa <span th:text="${mesa.id}">01</span></h2>

        <div class="comanda-container">

            <!-- Definindo variáveis locais para cálculos de totais -->
            <div class="comanda-box"
                 th:with="temPedidos=${not #lists.isEmpty(mesa.pedidos)},
                              subtotal=${temPedidos ? #aggregates.sum(mesa.pedidos.![itemValor * quant]) : 0.0},
                              totalGorjeta=${temPedidos ? #aggregates.sum(mesa.pedidos.![itemValor * quant * (itemTipoPercGorjeta != null ? itemTipoPercGorjeta : 0) / 100.0]) : 0.0},
                              totalPago=${not #lists.isEmpty(mesa.pagamentos) ? #aggregates.sum(mesa.pagamentos.![valor]) : 0.0}">

                <h3 style="color: var(--accent); margin-bottom: 20px;">Consumo</h3>

                <table class="table-items">
                    <thead>
                    <tr>
                        <th>Item</th>
                        <th>Qtd</th>
                        <th>Preço</th>
                        <th>Total</th>
                        <th sec:authorize="hasRole('GARCOM')"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Iterando sobre Set<PedidoDto> -->
                    <tr th:each="pedido : ${mesa.pedidos}">
                        <td>
                            <div th:text="${pedido.itemNome}">Nome do Item</div>
                            <small style="color: #666;" th:text="${pedido.itemTipoNome}">Tipo</small>
                        </td>
                        <td th:text="${pedido.quant}">1</td>
                        <td th:text="${#numbers.formatCurrency(pedido.itemValor)}">R$ 0,00</td>
                        <td th:text="${#numbers.formatCurrency(pedido.itemValor * pedido.quant)}">R$ 0,00</td>

                        <td class="actions" sec:authorize="hasRole('GARCOM')">
                            <button class="btn btn-outline btn-sm"
                                    onclick="abrirModalCancelamento(this)"
                                    th:data-id="${pedido.id}"
                                    title="Cancelar Item">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(mesa.pedidos)}">
                        <td colspan="5" style="text-align: center; font-style: italic;">Nenhum pedido realizado.</td>
                    </tr>
                    </tbody>
                </table>

                <!-- Resumo Financeiro -->
                <div class="financial-summary">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span th:text="${#numbers.formatCurrency(subtotal)}">R$ 0,00</span>
                    </div>

                    <div class="summary-row">
                        <span>Serviço (Gorjeta)</span>
                        <span th:text="${#numbers.formatCurrency(totalGorjeta)}">R$ 0,00</span>
                    </div>

                    <div class="summary-row">
                            <span>Entrada/Couvert
                                <small th:if="${!mesa.pagaEntrada}">(Isento)</small>
                            </span>
                        <span th:text="${mesa.pagaEntrada ? 'Ativo' : 'R$ 0,00'}">Status</span>
                    </div>

                    <div class="summary-row" th:if="${totalPago > 0}">
                        <span style="color: #27ae60;">Já Pago</span>
                        <span style="color: #27ae60;" th:text="${'- ' + #numbers.formatCurrency(totalPago)}">R$ 0,00</span>
                    </div>

                    <div class="summary-row total">
                        <span>TOTAL (Est.)</span>
                        <span th:text="${#numbers.formatCurrency(subtotal + totalGorjeta - totalPago)}">R$ 0,00</span>
                    </div>
                </div>
            </div>

            <!-- COLUNA DIREITA: AÇÕES -->
            <div class="actions-panel" sec:authorize="hasRole('GARCOM')">
                <div class="comanda-box">
                    <h3>Operações</h3>

                    <div class="action-btn-group">
                        <a th:href="@{/mesas/{id}/adicionar(id=${mesa.id})}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Adicionar Item
                        </a>

                        <!-- Toggle Entrada -->
                        <form th:action="@{/mesas/{id}/toggle-entrada(id=${mesa.id})}" method="post">
                            <button type="submit" class="btn btn-outline" style="width: 100%;">
                                <i class="fas fa-ticket-alt"></i>
                                <span th:text="${mesa.pagaEntrada ? 'Isentar Entrada' : 'Cobrar Entrada'}">Entrada</span>
                            </button>
                        </form>

                        <hr style="border-color: #333; margin: 10px 0;">

                        <a th:href="@{/mesas/{id}/pagamento(id=${mesa.id})}" class="btn btn-outline" style="border-color: #27ae60; color: #27ae60;">
                            <i class="fas fa-dollar-sign"></i> Registrar Pagamento
                        </a>

                        <form th:action="@{/mesas/{id}/fechar(id=${mesa.id})}" method="post" onsubmit="return confirm('Confirma o fechamento da mesa?');">
                            <button type="submit" class="btn btn-danger" style="width: 100%;">
                                <i class="fas fa-lock"></i> Fechar Mesa
                            </button>
                        </form>
                    </div>
                </div>
            </div>

        </div>

        <!-- Script movido para dentro da section para ser incluído no layout -->
        <script>
            function abrirModalCancelamento(btn) {
                const idItem = btn.getAttribute('data-id');
                const motivo = prompt("Motivo do cancelamento:");
                if (motivo) {
                    window.location.href = `/pedidos/${idItem}/cancelar?motivo=${encodeURIComponent(motivo)}`;
                }
            }
        </script>
    </div>
</section>

</body>
</html>
